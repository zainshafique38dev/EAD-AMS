@model dynamic

@{
    ViewData["Title"] = "Monthly Attendance Report";
    var selectedMonth = (int)ViewBag.SelectedMonth;
    var selectedYear = (int)ViewBag.SelectedYear;
    var monthName = new DateTime(selectedYear, selectedMonth, 1).ToString("MMMM yyyy");
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a asp-controller="Admin" asp-action="Index"><i class="fas fa-home"></i> Dashboard</a></li>
                    <li class="breadcrumb-item"><a asp-action="Index">Attendance</a></li>
                    <li class="breadcrumb-item active">Monthly Report</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-5">
                            <label class="form-label fw-bold">
                                <i class="fas fa-calendar-alt"></i> Select Month
                            </label>
                            <select name="month" class="form-select form-select-lg">
                                @for (int i = 1; i <= 12; i++)
                                {
                                    <option value="@i" selected="@(i == selectedMonth)">
                                        @(new DateTime(selectedYear, i, 1).ToString("MMMM"))
                                    </option>
                                }
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-calendar"></i> Select Year
                            </label>
                            <select name="year" class="form-select form-select-lg">
                                @for (int y = DateTime.Now.Year - 2; y <= DateTime.Now.Year + 1; y++)
                                {
                                    <option value="@y" selected="@(y == selectedYear)">@y</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary btn-lg w-100">
                                <i class="fas fa-search"></i> Generate Report
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-info text-white border-0 shadow-sm">
                <div class="card-body text-center">
                    <h6 class="mb-1">Report Period</h6>
                    <h3 class="mb-0">@monthName</h3>
                    <small>View detailed meal consumption</small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card border-0 shadow-sm">
    <div class="card-header bg-white border-bottom">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-chart-bar"></i> Meal Consumption Report - @monthName
            </h5>
            <div>
                <button onclick="location.reload()" class="btn btn-sm btn-primary me-2">
                    <i class="fas fa-sync-alt"></i> Refresh Report
                </button>
                <a asp-action="Index" class="btn btn-sm btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Mark Attendance
                </a>
            </div>
        </div>
    </div>
    <div class="card-body">
        @{
            var modelList = Model as IEnumerable<dynamic>;
            var dailySummary = ViewBag.DailySummary as IEnumerable<dynamic>;
            var hasDailyAttendance = dailySummary != null && dailySummary.Any();
            var hasTeachers = modelList != null && modelList.Any();
        }
        @if (hasTeachers)
        {
            @if (hasDailyAttendance)
            {
                <!-- Daily Attendance Summary -->
                <div class="alert alert-success border-success mb-4">
                    <h6 class="mb-2"><i class="fas fa-calendar-check"></i> <strong>Days with Marked Attendance</strong></h6>
                    <div class="row g-2">
                        @if (dailySummary != null)
                        {
                            @foreach (var day in dailySummary)
                            {
                                var dayDate = (DateTime)day.Date;
                                <div class="col-md-3">
                                    <div class="card border-success">
                                        <div class="card-body p-2 text-center">
                                            <small class="text-muted d-block">@dayDate.DayOfWeek</small>
                                            <strong class="text-success">@dayDate.ToString("MMM dd")</strong>
                                            <br />
                                            <small class="text-muted">
                                                <i class="fas fa-users"></i> @day.TeachersCount teacher(s) | 
                                                <i class="fas fa-utensils"></i> @day.TotalMeals meals
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                    <small class="text-muted mt-2 d-block">
                        <i class="fas fa-info-circle"></i> Total of <strong>@(dailySummary?.Count() ?? 0)</strong> day(s) with attendance marked in this period. 
                        Admin can mark attendance for any previous or current date.
                    </small>
                </div>
            }
            else
            {
                <!-- No Daily Attendance -->
                <div class="alert alert-warning border-warning mb-4">
                    <h6 class="mb-2"><i class="fas fa-exclamation-triangle"></i> <strong>No Attendance Marked</strong></h6>
                    <p class="mb-2">No attendance has been marked for any date in @monthName yet.</p>
                    <a asp-action="Index" class="btn btn-sm btn-primary">
                        <i class="fas fa-clipboard-check"></i> Go to Mark Attendance
                    </a>
                </div>
            }
            
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-warning text-dark border-0">
                        <div class="card-body text-center">
                            <h6 class="mb-1"><i class="fas fa-coffee"></i> Total Breakfasts</h6>
                            <h2 class="mb-0">@(modelList?.Sum(r => (int)r.TotalBreakfast) ?? 0)</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white border-0">
                        <div class="card-body text-center">
                            <h6 class="mb-1"><i class="fas fa-utensils"></i> Total Lunches</h6>
                            <h2 class="mb-0">@(modelList?.Sum(r => (int)r.TotalLunch) ?? 0)</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white border-0">
                        <div class="card-body text-center">
                            <h6 class="mb-1"><i class="fas fa-moon"></i> Total Dinners</h6>
                            <h2 class="mb-0">@(modelList?.Sum(r => (int)r.TotalDinner) ?? 0)</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-primary text-white border-0">
                        <div class="card-body text-center">
                            <h6 class="mb-1"><i class="fas fa-calculator"></i> Total Meals</h6>
                            <h2 class="mb-0">@(modelList?.Sum(r => (int)r.TotalMeals) ?? 0)</h2>
                        </div>
                    </div>
                </div>
            </div>

            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Report Summary:</strong> Showing meal consumption for <strong>@(modelList?.Count() ?? 0)</strong> teacher(s) during @monthName. 
                @if (hasDailyAttendance)
                {
                    <text>This data is used for monthly bill generation.</text>
                }
                else
                {
                    <text>No meals have been marked yet for this period.</text>
                }
                <br />
                <small class="text-muted">
                    <i class="fas fa-sync-alt"></i> This report automatically updates when you mark attendance for any date in this month.
                    Last generated: <strong>@DateTime.Now.ToString("MMM dd, yyyy hh:mm:ss tt")</strong>
                </small>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle" id="reportTable">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 5%">#</th>
                            <th style="width: 30%">Teacher Name</th>
                            <th class="text-center" style="width: 15%">
                                <i class="fas fa-coffee text-warning"></i><br />Breakfast
                            </th>
                            <th class="text-center" style="width: 15%">
                                <i class="fas fa-utensils text-success"></i><br />Lunch
                            </th>
                            <th class="text-center" style="width: 15%">
                                <i class="fas fa-moon text-info"></i><br />Dinner
                            </th>
                            <th class="text-center" style="width: 20%">
                                <i class="fas fa-chart-line"></i><br />Total Meals
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            var index = 1;
                        }
                        @if (modelList != null)
                        {
                            @foreach (var record in modelList)
                            {
                                <tr>
                                    <td class="text-muted">@index</td>
                                    <td><strong>@record.TeacherName</strong></td>
                                <td class="text-center">
                                    <span class="badge bg-warning text-dark px-3 py-2" style="font-size: 1rem;">@record.TotalBreakfast</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-success px-3 py-2" style="font-size: 1rem;">@record.TotalLunch</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-info px-3 py-2" style="font-size: 1rem;">@record.TotalDinner</span>
                                </td>
                                <td class="text-center">
                                    <h5 class="mb-0">
                                        <span class="badge bg-primary px-3 py-2">@record.TotalMeals</span>
                                    </h5>
                                </td>
                            </tr>
                            index++;
                            }
                        }
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <td colspan="2"><strong><i class="fas fa-sum"></i> GRAND TOTAL</strong></td>
                            <td class="text-center">
                                <strong class="text-warning" style="font-size: 1.2rem;">@(modelList?.Sum(r => (int)r.TotalBreakfast) ?? 0)</strong>
                            </td>
                            <td class="text-center">
                                <strong class="text-success" style="font-size: 1.2rem;">@(modelList?.Sum(r => (int)r.TotalLunch) ?? 0)</strong>
                            </td>
                            <td class="text-center">
                                <strong class="text-info" style="font-size: 1.2rem;">@(modelList?.Sum(r => (int)r.TotalDinner) ?? 0)</strong>
                            </td>
                            <td class="text-center">
                                <h5 class="mb-0">
                                    <strong class="text-primary" style="font-size: 1.3rem;">@(modelList?.Sum(r => (int)r.TotalMeals) ?? 0)</strong>
                                </h5>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="mt-4 d-flex justify-content-between align-items-center">
                <div>
                    <a asp-controller="Billing" asp-action="Generate" class="btn btn-success btn-lg">
                        <i class="fas fa-file-invoice-dollar"></i> Generate Bills for This Period
                    </a>
                </div>
                <div class="text-muted">
                    <small>
                        <i class="fas fa-clock"></i> Report generated on @DateTime.Now.ToString("MMM dd, yyyy hh:mm tt")
                    </small>
                </div>
            </div>
        }
        else
        {
            <div class="text-center py-5">
                <i class="fas fa-chart-line fa-4x text-muted mb-3"></i>
                <h5 class="text-muted">No Attendance Data Found</h5>
                <p class="text-muted">No attendance has been marked for @monthName yet.</p>
                <a asp-action="Index" class="btn btn-primary">
                    <i class="fas fa-clipboard-check"></i> Go to Mark Attendance
                </a>
            </div>
        }
    </div>
</div>
