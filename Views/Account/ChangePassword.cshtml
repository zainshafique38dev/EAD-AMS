@{
    ViewData["Title"] = "Change Password";
}

<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-key"></i> Change Password</h5>
            </div>
            <div class="card-body p-4">
                <div id="alertContainer"></div>

                @if (ViewBag.Error != null)
                {
                    <div class="alert alert-danger alert-dismissible fade show">
                        <i class="fas fa-exclamation-circle"></i> @ViewBag.Error
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                }

                @if (ViewBag.Success != null)
                {
                    <div class="alert alert-success alert-dismissible fade show">
                        <i class="fas fa-check-circle"></i> @ViewBag.Success
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                }

                <form asp-action="ChangePassword" method="post" id="changePasswordForm">
                    @Html.AntiForgeryToken()

                    <div class="mb-3">
                        <label for="currentPassword" class="form-label fw-bold">
                            <i class="fas fa-lock"></i> Current Password
                        </label>
                        <div class="input-group">
                            <input type="password" 
                                   class="form-control" 
                                   id="currentPassword" 
                                   name="currentPassword" 
                                   placeholder="Enter current password"
                                   required />
                            <button class="btn btn-outline-secondary toggle-password" type="button" data-target="currentPassword">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="newPassword" class="form-label fw-bold">
                            <i class="fas fa-key"></i> New Password
                        </label>
                        <div class="input-group">
                            <input type="password" 
                                   class="form-control" 
                                   id="newPassword" 
                                   name="newPassword" 
                                   placeholder="Enter new password"
                                   minlength="6"
                                   required />
                            <button class="btn btn-outline-secondary toggle-password" type="button" data-target="newPassword">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div id="passwordStrength" class="mt-2"></div>
                        <small class="form-text text-muted">Password must be at least 6 characters long.</small>
                    </div>

                    <div class="mb-4">
                        <label for="confirmPassword" class="form-label fw-bold">
                            <i class="fas fa-check-double"></i> Confirm New Password
                        </label>
                        <div class="input-group">
                            <input type="password" 
                                   class="form-control" 
                                   id="confirmPassword" 
                                   name="confirmPassword" 
                                   placeholder="Confirm new password"
                                   minlength="6"
                                   required />
                            <button class="btn btn-outline-secondary toggle-password" type="button" data-target="confirmPassword">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div id="passwordMatch" class="mt-2"></div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                            <span><i class="fas fa-save"></i> Change Password</span>
                        </button>
                        @if (User.IsInRole("Admin"))
                        {
                            <a asp-controller="Admin" asp-action="Index" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                        }
                        else
                        {
                            <a asp-controller="Teachers" asp-action="Index" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                        }
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Toggle password visibility
            $('.toggle-password').on('click', function() {
                const targetId = $(this).data('target');
                const input = $('#' + targetId);
                const icon = $(this).find('i');
                
                if (input.attr('type') === 'password') {
                    input.attr('type', 'text');
                    icon.removeClass('fa-eye').addClass('fa-eye-slash');
                } else {
                    input.attr('type', 'password');
                    icon.removeClass('fa-eye-slash').addClass('fa-eye');
                }
            });

            // Password strength indicator
            $('#newPassword').on('input', function() {
                const password = $(this).val();
                updatePasswordStrength(password);
                checkPasswordMatch();
            });

            // Password match checker
            $('#confirmPassword').on('input', function() {
                checkPasswordMatch();
            });

            // Form submission with AJAX
            $('#changePasswordForm').on('submit', function(e) {
                e.preventDefault();
                
                // Clear previous alerts
                $('#alertContainer').empty();
                $('.form-control').removeClass('is-invalid');
                
                const currentPassword = $('#currentPassword').val();
                const newPassword = $('#newPassword').val();
                const confirmPassword = $('#confirmPassword').val();
                
                // Validation
                let isValid = true;
                
                if (!currentPassword) {
                    showFieldError($('#currentPassword'), 'Current password is required');
                    isValid = false;
                }
                
                if (!newPassword || newPassword.length < 6) {
                    showFieldError($('#newPassword'), 'New password must be at least 6 characters');
                    isValid = false;
                }
                
                if (newPassword !== confirmPassword) {
                    showFieldError($('#confirmPassword'), 'Passwords do not match');
                    isValid = false;
                }
                
                if (!isValid) return false;
                
                const btn = $('#submitBtn');
                btn.addClass('btn-loading').prop('disabled', true);
                
                $.ajax({
                    url: $(this).attr('action'),
                    method: 'POST',
                    data: $(this).serialize(),
                    success: function(response) {
                        btn.removeClass('btn-loading').prop('disabled', false);
                        
                        // Check if redirected to login (success case for forced password change)
                        if (typeof response === 'string' && (response.includes('Login') || response.includes('Index'))) {
                            MessApp.showToast('Password changed successfully!', 'success');
                            setTimeout(function() {
                                window.location.reload();
                            }, 1500);
                        } else {
                            // Show success message
                            showAlert('Password changed successfully!', 'success');
                            $('#changePasswordForm')[0].reset();
                            $('#passwordStrength').empty();
                            $('#passwordMatch').empty();
                        }
                    },
                    error: function(xhr) {
                        btn.removeClass('btn-loading').prop('disabled', false);
                        showAlert('An error occurred. Please try again.', 'danger');
                    }
                });
            });

            function updatePasswordStrength(password) {
                let strength = 0;
                let checks = [];
                
                if (password.length >= 6) {
                    strength++;
                    checks.push('<span class="text-success"><i class="fas fa-check"></i> At least 6 characters</span>');
                } else {
                    checks.push('<span class="text-danger"><i class="fas fa-times"></i> At least 6 characters</span>');
                }
                
                if (password.length >= 10) strength++;
                if (/[A-Z]/.test(password)) strength++;
                if (/[0-9]/.test(password)) strength++;
                if (/[^A-Za-z0-9]/.test(password)) strength++;

                const strengthText = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong'];
                const strengthClass = ['danger', 'warning', 'warning', 'info', 'success'];
                const strengthPercent = [20, 40, 60, 80, 100];
                
                if (password.length > 0) {
                    $('#passwordStrength').html(`
                        <div class="progress" style="height: 5px;">
                            <div class="progress-bar bg-${strengthClass[strength]}" style="width: ${strengthPercent[strength]}%"></div>
                        </div>
                        <small class="text-${strengthClass[strength]}">Strength: ${strengthText[strength]}</small>
                    `);
                } else {
                    $('#passwordStrength').empty();
                }
            }

            function checkPasswordMatch() {
                const newPassword = $('#newPassword').val();
                const confirmPassword = $('#confirmPassword').val();
                
                if (confirmPassword.length > 0) {
                    if (newPassword === confirmPassword) {
                        $('#passwordMatch').html('<small class="text-success"><i class="fas fa-check"></i> Passwords match</small>');
                        $('#confirmPassword').removeClass('is-invalid').addClass('is-valid');
                    } else {
                        $('#passwordMatch').html('<small class="text-danger"><i class="fas fa-times"></i> Passwords do not match</small>');
                        $('#confirmPassword').removeClass('is-valid').addClass('is-invalid');
                    }
                } else {
                    $('#passwordMatch').empty();
                    $('#confirmPassword').removeClass('is-valid is-invalid');
                }
            }

            function showFieldError(field, message) {
                field.addClass('is-invalid');
                if (!field.parent().find('.invalid-feedback').length) {
                    field.parent().after('<div class="invalid-feedback d-block">' + message + '</div>');
                }
            }

            function showAlert(message, type) {
                $('#alertContainer').html(`
                    <div class="alert alert-${type} alert-dismissible fade show alert-animated">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `);
            }

            // Clear validation on input
            $('.form-control').on('input', function() {
                $(this).removeClass('is-invalid');
                $(this).parent().siblings('.invalid-feedback').remove();
            });
        });
    </script>
}
